<!doctype html>
<html lang="lt">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>Nustatymai - Auto Laistymas</title>
  <link rel="stylesheet" href="/ui/styles.css">
  <script src="/ui/common.js"></script>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div class="logo">
        <span>âš™ï¸</span>
        <span>Nustatymai</span>
      </div>
      <div class="nav-links">
        <a href="/" title="PradÅ¾ia">ğŸ </a>
      </div>
      <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()" title="Keisti stiliÅ³">
        <span id="themeIcon">ğŸŒ™</span>
      </button>
    </div>
    <div id="globalMsg" class="global hidden"></div>
  </div>

  <div class="card time-settings-card">
    <h2>ğŸ• Laistymo laikai (per dienÄ…)</h2>
    <div class="time-list-container">
      <ul id="timesList" class="time-list"></ul>
          </div>
    <div class="time-input-section">
      <div class="time-input-group">
        <label for="newTimeInput">PridÄ—ti laikÄ… (HH:MM)</label>
        <div class="input-with-button">
          <input id="newTimeInput" type="time" step="60" placeholder="06:00" class="time-input">
          <button id="addTimeBtn" type="button" class="add-time-btn">â• PridÄ—ti</button>
        </div>
        <div class="setting-description">Kada sistema automatiÅ¡kai pradÄ—s laistymÄ…</div>
      </div>
    </div>
    <div class="info-tip">ğŸ’¡ Patarimas: rekomenduojama 1â€“8 laikai per dienÄ…. Pavyzdys: 06:00 ir 20:00.</div>
  </div>

  <div class="card rtc-settings-card">
    <h2>ğŸ•’ Laiko nustatymai (RTC)</h2>
    <div class="rtc-actions">
      <button id="setNowBtn" type="button" class="set-now-btn">ğŸ•’ Nustatyti dabartinÄ¯ narÅ¡yklÄ—s laikÄ…</button>
    </div>

  </div>

  <div class="card basic-settings-card">
    <h2>âš™ï¸ Baziniai nustatymai</h2>
    <div class="basic-settings-grid">
      <div class="setting-item">
        <label for="wateringDurationMin">Laistymo trukmÄ— (min)</label>
        <input id="wateringDurationMin" type="number" min="1" step="1" placeholder="30" class="setting-input">
                <div class="setting-description">Kiek minuÄiÅ³ trunka vienas laistymo ciklas. Per ilgas laistymas gali uÅ¾lieti augalus, per trumpas - nepatekti vandens. Rekomenduojama: 1-30 minuÄiÅ³, priklausomai nuo augalÅ³ poreikiÅ³ ir dirvoÅ¾emio tipo.</div>
      </div>
      <div class="setting-item">
        <label for="toleranceWindowMin">Laistymo langas (min)</label>
        <input id="toleranceWindowMin" type="number" min="1" step="1" placeholder="60" class="setting-input">
                <div class="setting-description">Kiek minuÄiÅ³ po suplanuoto laiko gali pradÄ—ti laistymÄ…. Didesnis langas leidÅ¾ia sistemai laistyti net jei sÄ…lygos nebuvo tinkamos tiksliai suplanuotu laiku. Rekomenduojama: 15-120 minuÄiÅ³, priklausomai nuo augalÅ³ poreikiÅ³ ir orÅ³ sÄ…lygÅ³.</div>
      </div>
      <div class="setting-item">
        <label for="sensorReadIntervalMs">JutikliÅ³ nuskaitymo intervalas (ms)</label>
        <input id="sensorReadIntervalMs" type="number" min="100" step="50" placeholder="1000" class="setting-input">
                <div class="setting-description">Kaip daÅ¾nai nuskaitomi BME280 ir vandens lygio jutikliai. MaÅ¾esnis intervalas = tiksliau duomenys ir greiÄiau reaguojama Ä¯ pokyÄius, bet didesnis energijos suvartojimas. Rekomenduojama: 500ms - 5000ms, priklausomai nuo poreikio tikslumui.</div>
      </div>
      <div class="setting-item">
        <label for="pauseResumeCheckIntervalMs">PauzÄ—s tikrinimo intervalas (ms)</label>
        <input id="pauseResumeCheckIntervalMs" type="number" min="100" step="50" placeholder="5000" class="setting-input">
                <div class="setting-description">Kaip daÅ¾nai tikrinama, ar galima atnaujinti laistymÄ… po pauzÄ—s. MaÅ¾esnis intervalas = greiÄiau atnaujins laistymÄ…, bet daugiau CPU apkrovos. Rekomenduojama: 1000ms - 10000ms, priklausomai nuo poreikio greiÄiui.</div>
      </div>
    </div>
  </div>

  <div class="card water-level-card">
    <h2>ğŸ’§ Vandens lygio jutiklis</h2>
    <div class="water-level-grid">
      <div class="setting-item">
        <label for="wlMinState">Minimalus lygio stovis</label>
        <select id="wlMinState" class="setting-select">
          <option value="HIGH">HIGH</option>
          <option value="LOW">LOW</option>
        </select>
                <div class="setting-description">Koks signalas reiÅ¡kia, kad vandens yra (HIGH arba LOW logika). DaÅ¾niausiai HIGH = vandens yra, LOW = vandens nÄ—ra, bet priklauso nuo jutiklio tipo ir schemos. Patikrinkite savo jutiklio dokumentacijÄ… arba pabandykite abu variantus.</div>
      </div>
      <div class="setting-item">
        <label for="wlDebounceSamples">Debounce imÄiÅ³ skaiÄius (1-10)</label>
        <input id="wlDebounceSamples" type="number" min="1" max="10" step="1" placeholder="5" class="setting-input">
                <div class="setting-description">Kiek imÄiÅ³ reikia, kad bÅ«tÅ³ patvirtintas vandens lygis. Daugiau imÄiÅ³ = stabiliau ir maÅ¾iau klaidÅ³, bet lÄ—Äiau reaguoja Ä¯ vandens lygio pokyÄius. Rekomenduojama: 3-7 imtys, priklausomai nuo jutiklio stabilumo.</div>
      </div>
      <div class="setting-item">
        <label for="wlDebounceIntervalMs">Debounce intervalas (ms)</label>
        <input id="wlDebounceIntervalMs" type="number" min="1" step="1" placeholder="100" class="setting-input">
                <div class="setting-description">Laikas tarp imÄiÅ³ nuskaitymo. MaÅ¾esnis intervalas = greiÄiau tikrinimas ir reaguojama Ä¯ pokyÄius, bet daugiau energijos suvartojimo. Rekomenduojama: 50ms - 500ms, priklausomai nuo poreikio greiÄiui ir energijos taupymui.</div>
      </div>
      <div class="setting-item">
        <label for="wlPullMode">Ä®Ä—jimo reÅ¾imas</label>
        <select id="wlPullMode" class="setting-select">
          <option value="PULLUP">PULLUP</option>
          <option value="PULLDOWN">PULLDOWN</option>
        </select>
                <div class="setting-description">ESP32 pin'o pull-up arba pull-down rezistorius. PULLUP = 3.3V, PULLDOWN = 0V. Priklauso nuo jutiklio schemos ir ESP32 pin'o. Jei jutiklis neveikia stabiliai, pabandykite pakeisti Å¡Ä¯ nustatymÄ….</div>
      </div>
    </div>
  </div>

  <div class="card bme280-card">
    <h2>ğŸŒ¡ï¸ BME280 ribos</h2>
    <div class="bme280-grid">
      <div class="setting-item">
        <label for="bmeTempMin">TemperatÅ«ra min (Â°C)</label>
        <input id="bmeTempMin" type="number" step="0.1" placeholder="10.0" class="setting-input">
                <div class="setting-description">Minimali temperatÅ«ra, kurioje leidÅ¾iamas laistymas. Per Å¾ema temperatÅ«ra gali pakenkti augalams ir uÅ¾Å¡aldyti vandenÄ¯. Rekomenduojama: ne Å¾emesnÄ— nei 5Â°C, priklausomai nuo augalÅ³ atsparumo Å¡alÄiui.</div>
      </div>
      <div class="setting-item">
        <label for="bmeTempMax">TemperatÅ«ra max (Â°C)</label>
        <input id="bmeTempMax" type="number" step="0.1" placeholder="35.0" class="setting-input">
                <div class="setting-description">Maksimali temperatÅ«ra, kurioje leidÅ¾iamas laistymas. Per aukÅ¡ta temperatÅ«ra gali iÅ¡garinti vandenÄ¯ ir pakenkti augalams. Rekomenduojama: ne aukÅ¡tesnÄ— nei 40Â°C, priklausomai nuo augalÅ³ atsparumo karÅ¡Äiui.</div>
      </div>
      <div class="setting-item">
        <label for="bmeHumMin">DrÄ—gmÄ— min (%)</label>
        <input id="bmeHumMin" type="number" step="0.1" placeholder="30.0" class="setting-input">
                <div class="setting-description">Minimali drÄ—gmÄ—, kurioje leidÅ¾iamas laistymas. Per Å¾ema drÄ—gmÄ— reiÅ¡kia, kad augalai iÅ¡dÅ¾iÅ«sta ir reikia laistymo. Rekomenduojama: ne Å¾emesnÄ— nei 20%, priklausomai nuo augalÅ³ poreikiÅ³ ir aplinkos sÄ…lygÅ³.</div>
      </div>
      <div class="setting-item">
        <label for="bmeHumMax">DrÄ—gmÄ— max (%)</label>
        <input id="bmeHumMax" type="number" step="0.1" placeholder="80.0" class="setting-input">
                <div class="setting-description">Maksimali drÄ—gmÄ—, kurioje leidÅ¾iamas laistymas. Per aukÅ¡ta drÄ—gmÄ— gali sukelti pelÄ—sÄ¯, lÄ—tinti augalÅ³ augimÄ… ir sukelti Å¡aknÅ³ puvimÄ…. Rekomenduojama: ne aukÅ¡tesnÄ— nei 90%, priklausomai nuo augalÅ³ poreikiÅ³ ir vÄ—dinimo.</div>
      </div>
      <div class="setting-item">
        <label for="bmePresMin">SlÄ—gis min (hPa)</label>
        <input id="bmePresMin" type="number" step="0.1" placeholder="900.0" class="setting-input">
                <div class="setting-description">Minimalus slÄ—gis, kurioje leidÅ¾iamas laistymas. Å½emas slÄ—gis gali reikÅ¡ti audrÄ…, stiprÅ³ vÄ—jÄ… ar nepalankias orÅ³ sÄ…lygas. Rekomenduojama: ne Å¾emesnis nei 850 hPa, priklausomai nuo regiono klimato ir sezoniniÅ³ pokyÄiÅ³.</div>
      </div>
      <div class="setting-item">
        <label for="bmePresMax">SlÄ—gis max (hPa)</label>
        <input id="bmePresMax" type="number" step="0.1" placeholder="1100.0" class="setting-input">
                <div class="setting-description">Maksimalus slÄ—gis, kurioje leidÅ¾iamas laistymas. AukÅ¡tas slÄ—gis gali reikÅ¡ti saulÄ—tÄ… orÄ…, maÅ¾Ä… drÄ—gmÄ™ ir didesnÄ¯ vandens poreikÄ¯. Rekomenduojama: ne aukÅ¡tesnis nei 1200 hPa, priklausomai nuo regiono klimato ir sezoniniÅ³ pokyÄiÅ³.</div>
      </div>
    </div>
  </div>

  <div class="card wifi-card">
    <h2>ğŸ“¶ Wiâ€‘Fi (SoftAP)</h2>
    <div class="wifi-grid">
      <div class="setting-item">
        <label for="apSsid">SSID</label>
        <input id="apSsid" type="text" placeholder="AutoLaistymas" class="setting-input">
                <div class="setting-description">WiFi tinklo pavadinimas, kurÄ¯ sukurs ESP32. Naudokite aiÅ¡kÅ³ ir unikalÅ³ pavadinimÄ…, kad lengvai atpaÅ¾intumÄ—te savo sistemÄ… tinklo sÄ…raÅ¡e. Pavadinimas gali bÅ«ti bet koks, bet rekomenduojama naudoti lotyniÅ¡kas raides ir skaiÄius.</div>
      </div>
      <div class="setting-item">
        <label for="apPassword">SlaptaÅ¾odis</label>
        <input id="apPassword" type="text" placeholder="12345678" class="setting-input">
                <div class="setting-description">WiFi tinklo slaptaÅ¾odis (min 8 simboliÅ³). Naudokite stiprÅ³ slaptaÅ¾odÄ¯, kad kiti negalÄ—tÅ³ prisijungti prie jÅ«sÅ³ sistemos. Rekomenduojama: 8-20 simboliÅ³, Ä¯skaitant didÅ¾iÄ…sias ir maÅ¾Ä…sias raides, skaiÄius ir specialius simbolius.</div>
      </div>
      <div class="setting-item">
        <label for="apChannel">Kanalas</label>
        <input id="apChannel" type="number" min="1" max="13" step="1" placeholder="1" class="setting-input">
                <div class="setting-description">WiFi kanalas (1-13, rekomenduojama 1, 6 arba 11). Kanalai 1, 6 ir 11 nesikerta tarpusavyje, todÄ—l rekomenduojama pasirinkti maÅ¾iausiai uÅ¾imtÄ…. Jei matote lÄ—tÄ… WiFi greitÄ¯ ar nutrÅ«kimus, pabandykite pakeisti kanalÄ….</div>
      </div>
      <div class="setting-item">
        <label for="apHidden">PaslÄ—ptas SSID</label>
        <select id="apHidden" class="setting-select">
          <option value="false">Ne</option>
          <option value="true">Taip</option>
        </select>
                <div class="setting-description">Ar WiFi tinklas matomas tinklo sÄ…raÅ¡e. PaslÄ—ptas SSID = saugiau, nes tinklas nematomas kitiems, bet sunkiau prisijungti. Rekomenduojama palikti matomÄ… (Ne) paprastam naudojimui, paslÄ—pti (Taip) - didesniam saugumui.</div>
      </div>
    </div>
    <div class="info-tip">â„¹ï¸ Pastaba: pakeitus SSID, slaptaÅ¾odÄ¯, kanalÄ… ar paslÄ—ptÄ… SSID, reikÄ—s perkrauti Ä¯renginÄ¯.</div>
  </div>

  <div class="card">
    <h2>ğŸ”Œ RelÄ—</h2>
    <div class="row">
      <div class="col">
        <label for="relayActiveLevel">Aktyvus lygis</label>
        <select id="relayActiveLevel">
          <option value="LOW">LOW (daÅ¾niausia)</option>
          <option value="HIGH">HIGH</option>
        </select>
        <div class="setting-description">Koks signalas Ä¯jungia relÄ™ (LOW = 0V, HIGH = 3.3V). Dauguma relÄ—s moduliÅ³ naudoja LOW = Ä¯jungta, HIGH = iÅ¡jungta. Jei relÄ— neveikia, pabandykite pakeisti Å¡Ä¯ nustatymÄ….</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>ğŸ”„ UI atnaujinimas</h2>
    <div class="row">
      <div class="col">
        <label for="uiRefreshMs">Atnaujinimo intervalas (ms)</label>
        <input id="uiRefreshMs" type="number" min="250" step="250" placeholder="1000">
        <div class="setting-description">Kaip daÅ¾nai atnaujinama narÅ¡yklÄ—s sÄ…saja (ne Ä¯renginio logikai). MaÅ¾esnis intervalas = sklandesnÄ— sÄ…saja ir greiÄiau matysite pokyÄius, bet daugiau tinklo uÅ¾klausÅ³. Rekomenduojama: 1000ms (1s) - 5000ms (5s).</div>
      </div>
    </div>
  </div>

  <div class="actions">
    <button id="reloadBtn" class="secondary" type="button">ğŸ” Perkrauti iÅ¡ /config</button>
  </div>

  <script>
    // Tema valdoma iÅ¡ common.js

    // pad ir toIsoNoTZ funkcijos iÅ¡ common.js

    // showMessage funkcija iÅ¡ common.js

    // Laistymo laikÅ³ bÅ«sena
    let wateringTimes = [];

    // buildAuthHeaders funkcija iÅ¡ common.js

    async function loadConfig(){
      showSettingMessage('KonfigÅ«racija', 'Kraunama...', 'info');
      try {
        const res = await fetch('/config');
        if(!res.ok) throw new Error('Atsakymas: '+res.status);
        const cfg = await res.json();
        
        // Baziniai
        document.getElementById('wateringDurationMin').value = cfg.wateringDurationMin ?? '';
        document.getElementById('toleranceWindowMin').value = cfg.toleranceWindowMin ?? '';
        document.getElementById('sensorReadIntervalMs').value = cfg.sensorReadIntervalMs ?? '';
        document.getElementById('pauseResumeCheckIntervalMs').value = cfg.pauseResumeCheckIntervalMs ?? '';
        
        // WL
        document.getElementById('wlMinState').value = cfg.waterLevel?.minState || 'HIGH';
        document.getElementById('wlDebounceSamples').value = cfg.waterLevel?.debounceSamples ?? '';
        document.getElementById('wlDebounceIntervalMs').value = cfg.waterLevel?.debounceIntervalMs ?? '';
        document.getElementById('wlPullMode').value = cfg.waterLevel?.pullMode || 'PULLUP';
        
        // BME
        document.getElementById('bmeTempMin').value = cfg.bme280?.tempMin ?? '';
        document.getElementById('bmeTempMax').value = cfg.bme280?.tempMax ?? '';
        document.getElementById('bmeHumMin').value = cfg.bme280?.humMin ?? '';
        document.getElementById('bmeHumMax').value = cfg.bme280?.humMax ?? '';
        document.getElementById('bmePresMin').value = cfg.bme280?.presMin ?? '';
        document.getElementById('bmePresMax').value = cfg.bme280?.presMax ?? '';
        
        // WiFi
        document.getElementById('apSsid').value = cfg.wifi?.apSsid ?? '';
        document.getElementById('apPassword').value = cfg.wifi?.apPassword ?? '';
        document.getElementById('apChannel').value = cfg.wifi?.apChannel ?? '';
        document.getElementById('apHidden').value = String(cfg.wifi?.apHidden ?? false);
        
        // Relay
        document.getElementById('relayActiveLevel').value = cfg.relay?.activeLevel || 'LOW';
        
        // UI refresh interval from localStorage
        const uiMs = getRefreshMs(); // Naudojame getRefreshMs iÅ¡ common.js
        document.getElementById('uiRefreshMs').value = uiMs;
        
        // Laistymo laikai
        wateringTimes = Array.isArray(cfg.wateringTimes) ? cfg.wateringTimes.filter(isValidHHMM) : [];
        if(typeof renderTimes === 'function') renderTimes();
        
        showSettingMessage('KonfigÅ«racija', 'Ä®kelta sÄ—kmingai');
      } catch(e){
        showSettingMessage('KonfigÅ«racija', 'Klaida skaitant: ' + e.message, 'err');
      }
    }

    function collectConfig(){
      const v = id => document.getElementById(id).value;
      const n = id => Number(v(id));
      const cfg = {};

      // Baziniai: tik jei skaiÄius teisingas
      const addNum = (id, key) => { const num = n(id); if(Number.isFinite(num)) cfg[key] = num; };
      addNum('wateringDurationMin','wateringDurationMin');
      addNum('toleranceWindowMin','toleranceWindowMin');
      addNum('sensorReadIntervalMs','sensorReadIntervalMs');
      addNum('pauseResumeCheckIntervalMs','pauseResumeCheckIntervalMs');

      // WaterLevel
      const wl = {};
      wl.minState = v('wlMinState');
      const wlDebS = n('wlDebounceSamples'); if(Number.isFinite(wlDebS)) wl.debounceSamples = wlDebS;
      const wlDebI = n('wlDebounceIntervalMs'); if(Number.isFinite(wlDebI)) wl.debounceIntervalMs = wlDebI;
      wl.pullMode = v('wlPullMode');
      if(Object.keys(wl).length) cfg.waterLevel = wl;

      // BME
      const bme = {};
      const tmin = n('bmeTempMin'); if(Number.isFinite(tmin)) bme.tempMin = tmin;
      const tmax = n('bmeTempMax'); if(Number.isFinite(tmax)) bme.tempMax = tmax;
      const hmin = n('bmeHumMin'); if(Number.isFinite(hmin)) bme.humMin = hmin;
      const hmax = n('bmeHumMax'); if(Number.isFinite(hmax)) bme.humMax = hmax;
      const pmin = n('bmePresMin'); if(Number.isFinite(pmin)) bme.presMin = pmin;
      const pmax = n('bmePresMax'); if(Number.isFinite(pmax)) bme.presMax = pmax;
      if(Object.keys(bme).length) cfg.bme280 = bme;

      // WiFi
      const wifi = {};
      if(v('apSsid')) wifi.apSsid = v('apSsid');
      if(v('apPassword')) wifi.apPassword = v('apPassword');
      const ch = n('apChannel'); if(Number.isFinite(ch)) wifi.apChannel = ch;
      wifi.apHidden = (v('apHidden') === 'true');
      if(Object.keys(wifi).length) cfg.wifi = wifi;

      // Relay
      cfg.relay = { activeLevel: v('relayActiveLevel') };

      // Watering times (array of HH:MM)
      const items = Array.from(document.querySelectorAll('#timesList li[data-time]')).map(li => li.getAttribute('data-time'));
      cfg.wateringTimes = items;

      return cfg;
    }

    async function saveConfig(){
      try{
        const body = JSON.stringify(collectConfig());
        const headers = Object.assign({ 'Content-Type':'application/json' }, buildAuthHeaders());
        const res = await fetch('/config', { method:'POST', headers, body });
        if(!res.ok) {
        const text = await res.text();
          throw new Error(text||('HTTP '+res.status));
        }
        // Nerodome praneÅ¡imo apie iÅ¡saugojimÄ…, nes jis jau buvo parodytas validacijoje
      }catch(e){
        showSettingMessage('KonfigÅ«racija', 'Nepavyko iÅ¡saugoti: ' + e.message, 'err');
      }
    }

    async function saveTime(){
      const now = new Date();
      const t = toIsoNoTZ(now); // Naudojame toIsoNoTZ iÅ¡ common.js
      
      showSettingMessage('RTC laikas', 'SiunÄiamas...', 'info');
      try{
        const headers = Object.assign({ 'Content-Type':'application/json' }, buildAuthHeaders());
        const res = await fetch('/config/time', { method:'POST', headers, body: JSON.stringify({ time: t }) });
        if(!res.ok) {
        const text = await res.text();
          throw new Error(text||('HTTP '+res.status));
        }
        showSettingMessage('RTC laikas', 'Atnaujintas sÄ—kmingai');
      }catch(e){
        showSettingMessage('RTC laikas', 'Nepavyko atnaujinti: ' + e.message, 'err');
      }
    }

    // Events
    document.getElementById('reloadBtn').addEventListener('click', loadConfig);
    
    document.getElementById('setNowBtn').addEventListener('click', function(){
      saveTime();
    });
    
    // UI refresh interval auto-save on change
    document.getElementById('uiRefreshMs').addEventListener('change', function(){
      const v = document.getElementById('uiRefreshMs').value;
      if(setRefreshMs(v)){ // Naudojame setRefreshMs iÅ¡ common.js
        // ReikÅ¡mÄ— iÅ¡saugota sÄ—kmingai
      }
    });

    // Auto-save for all config fields on change/blur (except uiRefreshMs which has own handler)
    function isConfigControl(id){ return !['uiRefreshMs','newTimeInput'].includes(id); }
    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
    const debouncedSave = debounce(saveConfig, 500);
    
    // IndividualÅ«s praneÅ¡imai kiekvienam nustatymui
    function showSettingMessage(settingName, message, type = 'ok') {
      showMessage(`${settingName}: ${message}`, type);
    }
    
    // RibÅ³ tikrinimas ir praneÅ¡imai
    function validateAndShowMessage(inputId, value, min, max, settingName, unit = '') {
      const numValue = Number(value);
      if (isNaN(numValue)) {
        showSettingMessage(settingName, 'Neteisinga reikÅ¡mÄ—', 'err');
        return false;
      }
      
      if (min !== undefined && numValue < min) {
        showSettingMessage(settingName, `ReikÅ¡mÄ— per maÅ¾a. Minimali: ${min}${unit}`, 'warning');
        return false;
      }
      
      if (max !== undefined && numValue > max) {
        showSettingMessage(settingName, `ReikÅ¡mÄ— per didelÄ—. Maksimali: ${max}${unit}`, 'warning');
        return false;
      }
      
      // Nerodome "IÅ¡saugota" praneÅ¡imo, nes jis bus rodomas po debouncedSave
      return true;
    }
    
    // NustatymÅ³ validacija su praneÅ¡imais
    function validateWateringDuration(value) {
      return validateAndShowMessage('wateringDurationMin', value, 1, 60, 'Laistymo trukmÄ—', ' min');
    }
    
    function validateToleranceWindow(value) {
      return validateAndShowMessage('toleranceWindowMin', value, 5, 180, 'Laistymo langas', ' min');
    }
    
    function validateSensorInterval(value) {
      return validateAndShowMessage('sensorReadIntervalMs', value, 100, 10000, 'JutikliÅ³ intervalas', ' ms');
    }
    
    function validatePauseInterval(value) {
      return validateAndShowMessage('pauseResumeCheckIntervalMs', value, 100, 30000, 'PauzÄ—s intervalas', ' ms');
    }
    
    function validateDebounceSamples(value) {
      return validateAndShowMessage('wlDebounceSamples', value, 1, 10, 'Debounce imtys', '');
    }
    
    function validateDebounceInterval(value) {
      return validateAndShowMessage('wlDebounceIntervalMs', value, 10, 1000, 'Debounce intervalas', ' ms');
    }
    
    function validateTemperature(value, isMin) {
      const min = isMin ? -50 : -50;
      const max = isMin ? 50 : 100;
      const name = isMin ? 'TemperatÅ«ra min' : 'TemperatÅ«ra max';
      return validateAndShowMessage(isMin ? 'bmeTempMin' : 'bmeTempMax', value, min, max, name, 'Â°C');
    }
    
    function validateHumidity(value, isMin) {
      const min = isMin ? 0 : 0;
      const max = isMin ? 100 : 100;
      const name = isMin ? 'DrÄ—gmÄ— min' : 'DrÄ—gmÄ— max';
      return validateAndShowMessage(isMin ? 'bmeHumMin' : 'bmeHumMax', value, min, max, name, '%');
    }
    
    function validatePressure(value, isMin) {
      const min = isMin ? 500 : 500;
      const max = isMin ? 1500 : 1500;
      const name = isMin ? 'SlÄ—gis min' : 'SlÄ—gis max';
      return validateAndShowMessage(isMin ? 'bmePresMin' : 'bmePresMax', value, min, max, name, ' hPa');
    }
    
    // Event listeners su individualiais praneÅ¡imais
    document.addEventListener('change', function(e){ 
      if(e.target && (e.target.tagName==='INPUT'||e.target.tagName==='SELECT')){ 
        if(isConfigControl(e.target.id)) {
          // Tik validuojame, nerodome "IÅ¡saugota" praneÅ¡imo
          let isValid = true;
          switch(e.target.id) {
            case 'wateringDurationMin':
              isValid = validateWateringDuration(e.target.value);
              break;
            case 'toleranceWindowMin':
              isValid = validateToleranceWindow(e.target.value);
              break;
            case 'sensorReadIntervalMs':
              isValid = validateSensorInterval(e.target.value);
              break;
            case 'pauseResumeCheckIntervalMs':
              isValid = validatePauseInterval(e.target.value);
              break;
            case 'wlDebounceSamples':
              isValid = validateDebounceSamples(e.target.value);
              break;
            case 'wlDebounceIntervalMs':
              isValid = validateDebounceInterval(e.target.value);
              break;
            case 'bmeTempMin':
              isValid = validateTemperature(e.target.value, true);
              break;
            case 'bmeTempMax':
              isValid = validateTemperature(e.target.value, false);
              break;
            case 'bmeHumMin':
              isValid = validateHumidity(e.target.value, true);
              break;
            case 'bmeHumMax':
              isValid = validateHumidity(e.target.value, false);
              break;
            case 'bmePresMin':
              isValid = validatePressure(e.target.value, true);
              break;
            case 'bmePresMax':
              isValid = validatePressure(e.target.value, false);
              break;
            case 'wlMinState':
            case 'wlPullMode':
            case 'relayActiveLevel':
            case 'apSsid':
            case 'apPassword':
            case 'apChannel':
            case 'apHidden':
              // Select ir text input'ai neturi validacijos, tik iÅ¡saugojimas
              break;
            default:
              // Nerodome nieko
          }
          
          // IÅ¡saugojame tik jei validacija sÄ—kminga
          if (isValid) {
            debouncedSave();
          }
        }
      }
    });
    
    document.addEventListener('blur', function(e){ 
      if(e.target && (e.target.tagName==='INPUT')){ 
        if(isConfigControl(e.target.id)) {
          // Blur event'e tik iÅ¡saugojame, nerodome praneÅ¡imÅ³
          debouncedSave(); 
        }
      } 
    }, true);

    // Init
    loadConfig();

    // --- Laistymo laikÅ³ UI ---
    // isValidHHMM funkcija iÅ¡ common.js
    
    function renderTimes(){
      const ul = document.getElementById('timesList');
      ul.innerHTML = '';
      wateringTimes.forEach((t, idx) => {
        const li = document.createElement('li');
        li.setAttribute('data-time', t);
        const span = document.createElement('span'); 
        span.textContent = t;
        const btn = document.createElement('button'); 
        btn.type='button'; 
        btn.textContent='âœ–'; 
        btn.className='secondary';
        btn.addEventListener('click', ()=>{ 
          removeWateringTime(idx);
        });
        li.appendChild(span); 
        li.appendChild(btn); 
        ul.appendChild(li);
      });
    }

    document.getElementById('addTimeBtn').addEventListener('click', ()=>{
      const t = (document.getElementById('newTimeInput').value||'').trim();
      if(!isValidHHMM(t)){ 
        showSettingMessage('Laistymo laikas', 'Blogas formatas. Naudokite HH:MM', 'err'); 
        return; 
      }
      if(wateringTimes.includes(t)){ 
        showSettingMessage('Laistymo laikas', 'Toks laikas jau yra', 'warning'); 
        return; 
      }
      if(wateringTimes.length>=8){ 
        showSettingMessage('Laistymo laikas', 'Pasiektas maksimalus laikÅ³ skaiÄius (8)', 'warning'); 
        return; 
      }
      wateringTimes.push(t);
      wateringTimes.sort();
      renderTimes();
      debouncedSave();
      document.getElementById('newTimeInput').value = '';
      showSettingMessage('Laistymo laikas', 'PridÄ—ta: ' + t);
    });
    
    // IndividualÅ«s praneÅ¡imai laistymo laikÅ³ trinimui
    function removeWateringTime(index) {
      const removedTime = wateringTimes[index];
      wateringTimes.splice(index, 1);
      renderTimes();
      debouncedSave();
      showSettingMessage('Laistymo laikas', 'PaÅ¡alinta: ' + removedTime);
    }


  </script>
</body>
</html>
