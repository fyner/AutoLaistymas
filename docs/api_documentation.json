{
  "title": "AutoLaistymas REST API",
  "version": "1.1.0",
  "baseUrl": "http://192.168.4.1",
  "description": "ESP32 vietinės automatinio laistymo sistemos API. Serveris veikia SoftAP režimu be interneto.",
  "auth": {
    "type": "header",
    "header": "X-API-Token",
    "requiredFor": ["POST /config", "POST /config/time", "POST /start", "POST /stop", "POST /restart"],
    "notes": "Jei `apiToken` prietaise tuščias – autentifikacija nenaudojama (laikinai). Rekomenduojama nustatyti pakankamai ilgą slaptą tokeną."
  },
  "endpoints": [
    {
      "method": "GET",
      "path": "/status",
      "description": "Grąžina dabartinę sistemos būseną ir sensorių reikšmes.",
      "response": {
        "contentType": "application/json",
        "example": {
          "state": "Idle | WindowOpen | Watering | ErrorPaused",
          "currentTime": "2025-08-10T21:33:34",
          "temp": 23.5,
          "hum": 45.2,
          "pres": 1005.1,
          "waterLevel": "YRA | NERA",
          "remainingTimeSec": 120,
          "nextStartInSec": 3600,
          "windowRemainingSec": 0
        }
      }
    },
    {
      "method": "GET",
      "path": "/config",
      "description": "Grąžina einamąją konfigūraciją iš atminties. Pastaba: `apiToken` laukas į atsakymą neįtraukiamas dėl saugumo.",
      "response": {
        "contentType": "application/json",
        "example": {
          "time": "2025-05-08T08:00:00",
          "wateringDurationMin": 60,
          "toleranceWindowMin": 120,
          "sensorReadIntervalMs": 1000,
          "pauseResumeCheckIntervalMs": 1000,
          "wateringTimes": ["06:00", "20:00"],
          "waterLevel": {
            "minState": "HIGH",
            "debounceSamples": 5,
            "debounceIntervalMs": 50,
            "pullMode": "PULLUP"
          },
          "bme280": {
            "tempMin": 5.0,
            "tempMax": 35.0,
            "humMin": 30.0,
            "humMax": 80.0,
            "presMin": 950.0,
            "presMax": 1050.0
          },
          "wifi": {
            "apSsid": "AutoLaistymas",
            "apPassword": "esp32automatinis",
            "apChannel": 1,
            "apHidden": false
          },
          "relay": { "activeLevel": "LOW" }
        }
      }
    },
    {
      "method": "POST",
      "path": "/config",
      "description": "Atnaujina konfigūraciją. Kūnas – JSON. Galite perduoti tik keičiamus laukus. Jei perduodamas `apiToken`, jis bus atnaujintas (negrąžinamas per GET).",
      "request": {
        "contentType": "application/json",
        "body": "Toks pat formatas kaip GET /config pavyzdyje, plius papildomas laukas 'apiToken' (nebūtinas)."
      },
      "responses": [
        { "status": 200, "description": "Konfigūracija atnaujinta ir įrašyta į LittleFS (atominiu pervadinimu)." },
        { "status": 400, "description": "Neteisingas JSON arba reikšmės." },
        { "status": 401, "description": "Trūksta arba neteisingas X-API-Token." }
      ]
    },
    {
      "method": "POST",
      "path": "/config/time",
      "description": "Nustato RTC laiką ir išsaugo config.time.",
      "request": {
        "contentType": "application/json",
        "example": { "time": "2025-08-10T21:33:34" }
      },
      "responses": [
        { "status": 200, "description": "RTC laikas atnaujintas." },
        { "status": 400, "description": "Blogas laiko formatas." },
        { "status": 401, "description": "Trūksta arba neteisingas X-API-Token." }
      ]
    },
    {
      "method": "POST",
      "path": "/start",
      "description": "Rankiniu būdu pradeda laistymą, jei tenkinamos sąlygos (vanduo, BME ribos).",
      "responses": [
        { "status": 200, "description": "Laistymas pradėtas." },
        { "status": 409, "description": "Sąlygos netenkinamos arba jau vyksta laistymas." },
        { "status": 401, "description": "Trūksta arba neteisingas X-API-Token." }
      ]
    },
    {
      "method": "POST",
      "path": "/stop",
      "description": "Sustabdo vykstantį laistymą.",
      "responses": [
        { "status": 200, "description": "Laistymas sustabdytas." },
        { "status": 409, "description": "Nėra ką stabdyti." },
        { "status": 401, "description": "Trūksta arba neteisingas X-API-Token." }
      ]
    },
    {
      "method": "POST",
      "path": "/restart",
      "description": "Perkrauna įrenginį (ESP.restart). Reikalauja X-API-Token.",
      "responses": [
        { "status": 200, "description": "Perkraunama (atsakymas gali būti nepristatytas)." },
        { "status": 401, "description": "Trūksta arba neteisingas X-API-Token." }
      ]
    },
    {
      "method": "GET",
      "path": "/ui/*",
      "description": "Statiniai UI failai iš LittleFS (pagrindinis: /ui/index.html, nustatymai: /ui/settings.html).",
      "note": "Serveris: server.serveStatic(\"/ui\", LittleFS, \"/ui/\").setDefaultFile(\"index.html\");"
    }
  ],
  "notes": [
    "Jei RTC prarado galią, sistema bandys nustatyti laiką iš config.time per paleidimą.",
    "Debounce apsaugos: debounceSamples karpomas į [1..MAX_DEBOUNCE_SAMPLES]; mėginių ėmimas vykdomas pagal debounceIntervalMs.",
    "Planuoti laikai vykdomi kartą per dieną; slot'as pažymimas \"įvykdytu\" tik realiai pradėjus laistymą.",
    "ErrorPaused būsenoje relė išjungiama; grįžimas į Watering tik jei langas dar atviras, kitaip – į Idle.",
    "Konfigūracija įrašoma atominiu būdu: į laikiną failą ir pervadinant.",
    "UI: visos keitimo užklausos siunčiamos su POST ir X-API-Token, jei nustatytas (laikomas naršyklės localStorage)."
  ]
}


